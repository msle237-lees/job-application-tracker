version: '3.8'

services:
  # FastAPI backend with React frontend
  app:
    build: .
    image: job-application-tracker:latest
    ports:
      - "9664:8000"
    volumes:
      - type: bind
        source: ${STACK_BASE_PATH:-/home/user/Documents/Personal_HomeLab/job-application-tracker}/job_tracker.db
        target: /app/job_tracker.db
      - type: bind
        source: ${STACK_BASE_PATH:-/home/user/Documents/Personal_HomeLab/job-application-tracker}/secret
        target: /app/secret
      - type: bind
        source: ${STACK_BASE_PATH:-/home/user/Documents/Personal_HomeLab/job-application-tracker}/logs
        target: /app/logs
    environment:
      - DATABASE_URL=sqlite:///./job_tracker.db
    restart: unless-stopped
    networks:
      - tracker-network
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.role == manager

  # Scheduled email checker service
  email-checker:
    build: .
    image: job-application-tracker:latest
    volumes:
      - type: bind
        source: ${STACK_BASE_PATH:-/home/user/Documents/Personal_HomeLab/job-application-tracker}/job_tracker.db
        target: /app/job_tracker.db
      - type: bind
        source: ${STACK_BASE_PATH:-/home/user/Documents/Personal_HomeLab/job-application-tracker}/secret
        target: /app/secret
      - type: bind
        source: ${STACK_BASE_PATH:-/home/user/Documents/Personal_HomeLab/job-application-tracker}/logs
        target: /app/logs
      - type: bind
        source: ${STACK_BASE_PATH:-/home/user/Documents/Personal_HomeLab/job-application-tracker}/email_config.json
        target: /app/email_config.json
    environment:
      - DATABASE_URL=sqlite:///./job_tracker.db
    command: python -u email_scheduler.py
    restart: unless-stopped
    networks:
      - tracker-network
    depends_on:
      - app
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.role == manager

networks:
  tracker-network:
    driver: overlay
    attachable: true
